<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lmsproject.lms_backend.mapper.EnrollmentMapper">
    
    <resultMap id="EnrollmentResultMap" type="com.lmsproject.lms_backend.model.Enrollment">
        <id property="enrollmentId" column="enrollment_id"/>
        <result property="studentId" column="student_id"/>
        <result property="courseId" column="course_id"/>
        <result property="studentName" column="student_name"/>
        <result property="courseName" column="course_name"/>
        <result property="courseCode" column="course_code"/>
        <result property="credits" column="credits"/>
        <result property="status" column="status"/>
        <result property="appliedAt" column="applied_at"/>
        <result property="approvedAt" column="approved_at"/>
        <result property="rejectedAt" column="rejected_at"/>
        <result property="cancelledAt" column="cancelled_at"/>
        <result property="rejectionReason" column="rejection_reason"/>
    </resultMap>
    
    <select id="findAll" resultMap="EnrollmentResultMap">
        SELECT e.enrollment_id, e.student_id, e.course_id,
               u.name as student_name,
               c.course_name, c.course_code, COALESCE(e.credits, c.credits) as credits,
               e.status, e.applied_at, e.approved_at, e.rejected_at, e.cancelled_at,
               e.rejection_reason
        FROM enrollments e
        LEFT JOIN users u ON e.student_id = u.user_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        ORDER BY e.applied_at DESC
    </select>
    
    <select id="findById" resultMap="EnrollmentResultMap">
        SELECT e.enrollment_id, e.student_id, e.course_id,
               u.name as student_name,
               c.course_name, c.course_code, COALESCE(e.credits, c.credits) as credits,
               e.status, e.applied_at, e.approved_at, e.rejected_at, e.cancelled_at,
               e.rejection_reason
        FROM enrollments e
        LEFT JOIN users u ON e.student_id = u.user_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE e.enrollment_id = #{enrollmentId}
    </select>
    
    <select id="findByStudentIdAndCourseId" resultMap="EnrollmentResultMap">
        SELECT e.enrollment_id, e.student_id, e.course_id,
               u.name as student_name,
               c.course_name, c.course_code, COALESCE(e.credits, c.credits) as credits,
               e.status, e.applied_at, e.approved_at, e.rejected_at, e.cancelled_at,
               e.rejection_reason
        FROM enrollments e
        LEFT JOIN users u ON e.student_id = u.user_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE e.student_id = #{studentId} AND e.course_id = #{courseId}
    </select>
    
    <select id="findByStudentId" resultMap="EnrollmentResultMap">
        SELECT e.enrollment_id, e.student_id, e.course_id,
               u.name as student_name,
               c.course_name, c.course_code, COALESCE(e.credits, c.credits) as credits,
               e.status, e.applied_at, e.approved_at, e.rejected_at, e.cancelled_at,
               e.rejection_reason
        FROM enrollments e
        LEFT JOIN users u ON e.student_id = u.user_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE e.student_id = #{studentId}
        ORDER BY e.applied_at DESC
    </select>
    
    <select id="findByCourseId" resultMap="EnrollmentResultMap">
        SELECT e.enrollment_id, e.student_id, e.course_id,
               u.name as student_name,
               c.course_name, c.course_code, COALESCE(e.credits, c.credits) as credits,
               e.status, e.applied_at, e.approved_at, e.rejected_at, e.cancelled_at,
               e.rejection_reason
        FROM enrollments e
        LEFT JOIN users u ON e.student_id = u.user_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE e.course_id = #{courseId}
        ORDER BY e.applied_at DESC
    </select>
    
    <select id="findByStatus" resultMap="EnrollmentResultMap">
        SELECT e.enrollment_id, e.student_id, e.course_id,
               u.name as student_name,
               c.course_name, c.course_code, COALESCE(e.credits, c.credits) as credits,
               e.status, e.applied_at, e.approved_at, e.rejected_at, e.cancelled_at,
               e.rejection_reason
        FROM enrollments e
        LEFT JOIN users u ON e.student_id = u.user_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE e.status = #{status}
        ORDER BY e.applied_at DESC
    </select>
    
    <insert id="insertEnrollment" useGeneratedKeys="true" keyProperty="enrollmentId">
        INSERT INTO enrollments (student_id, course_id, status, credits, applied_at)
        VALUES (#{studentId}, #{courseId}, #{status}, 
                (SELECT credits FROM courses WHERE course_id = #{courseId}), 
                CURRENT_TIMESTAMP)
    </insert>
    
    <update id="updateEnrollment">
        UPDATE enrollments
        SET status = #{status}
            <if test="status == 'APPROVED'">
                , approved_at = CURRENT_TIMESTAMP
                , rejected_at = NULL
                , cancelled_at = NULL
                , rejection_reason = NULL
            </if>
            <if test="status == 'REJECTED'">
                , rejected_at = CURRENT_TIMESTAMP
                , approved_at = NULL
                , cancelled_at = NULL
                , rejection_reason = #{rejectionReason}
            </if>
            <if test="status == 'CANCELLED'">
                , cancelled_at = CURRENT_TIMESTAMP
                , approved_at = NULL
                , rejected_at = NULL
                , rejection_reason = NULL
            </if>
            <if test="status == 'PENDING'">
                , approved_at = NULL
                , rejected_at = NULL
                , cancelled_at = NULL
                , rejection_reason = NULL
            </if>
        WHERE enrollment_id = #{enrollmentId}
    </update>
    
    <delete id="deleteEnrollment">
        DELETE FROM enrollments
        WHERE enrollment_id = #{enrollmentId}
    </delete>
    
</mapper>
