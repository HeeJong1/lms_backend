<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lmsproject.lms_backend.mapper.AttendanceMapper">
    
    <resultMap id="AttendanceResultMap" type="com.lmsproject.lms_backend.model.Attendance">
        <id property="attendanceId" column="attendance_id"/>
        <result property="enrollmentId" column="enrollment_id"/>
        <result property="studentId" column="student_id"/>
        <result property="courseId" column="course_id"/>
        <result property="studentName" column="student_name"/>
        <result property="courseName" column="course_name"/>
        <result property="courseCode" column="course_code"/>
        <result property="attendanceDate" column="attendance_date"/>
        <result property="status" column="status"/>
        <result property="notes" column="notes"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>
    
    <select id="findAll" resultMap="AttendanceResultMap">
        SELECT a.attendance_id, a.enrollment_id, a.student_id, a.course_id,
               u.name as student_name,
               c.course_name, c.course_code,
               a.attendance_date, a.status, a.notes, a.created_at
        FROM attendance a
        LEFT JOIN users u ON a.student_id = u.user_id
        LEFT JOIN courses c ON a.course_id = c.course_id
        ORDER BY a.attendance_date DESC, a.created_at DESC
    </select>
    
    <select id="findById" resultMap="AttendanceResultMap">
        SELECT a.attendance_id, a.enrollment_id, a.student_id, a.course_id,
               u.name as student_name,
               c.course_name, c.course_code,
               a.attendance_date, a.status, a.notes, a.created_at
        FROM attendance a
        LEFT JOIN users u ON a.student_id = u.user_id
        LEFT JOIN courses c ON a.course_id = c.course_id
        WHERE a.attendance_id = #{attendanceId}
    </select>
    
    <select id="findByEnrollmentId" resultMap="AttendanceResultMap">
        SELECT a.attendance_id, a.enrollment_id, a.student_id, a.course_id,
               u.name as student_name,
               c.course_name, c.course_code,
               a.attendance_date, a.status, a.notes, a.created_at
        FROM attendance a
        LEFT JOIN users u ON a.student_id = u.user_id
        LEFT JOIN courses c ON a.course_id = c.course_id
        WHERE a.enrollment_id = #{enrollmentId}
        ORDER BY a.attendance_date DESC
    </select>
    
    <select id="findByStudentId" resultMap="AttendanceResultMap">
        SELECT a.attendance_id, a.enrollment_id, a.student_id, a.course_id,
               u.name as student_name,
               c.course_name, c.course_code,
               a.attendance_date, a.status, a.notes, a.created_at
        FROM attendance a
        LEFT JOIN users u ON a.student_id = u.user_id
        LEFT JOIN courses c ON a.course_id = c.course_id
        WHERE a.student_id = #{studentId}
        ORDER BY a.attendance_date DESC
    </select>
    
    <select id="findByCourseId" resultMap="AttendanceResultMap">
        SELECT a.attendance_id, a.enrollment_id, a.student_id, a.course_id,
               u.name as student_name,
               c.course_name, c.course_code,
               a.attendance_date, a.status, a.notes, a.created_at
        FROM attendance a
        LEFT JOIN users u ON a.student_id = u.user_id
        LEFT JOIN courses c ON a.course_id = c.course_id
        WHERE a.course_id = #{courseId}
        ORDER BY a.attendance_date DESC, u.name
    </select>
    
    <select id="findByEnrollmentIdAndDate" resultMap="AttendanceResultMap">
        SELECT a.attendance_id, a.enrollment_id, a.student_id, a.course_id,
               u.name as student_name,
               c.course_name, c.course_code,
               a.attendance_date, a.status, a.notes, a.created_at
        FROM attendance a
        LEFT JOIN users u ON a.student_id = u.user_id
        LEFT JOIN courses c ON a.course_id = c.course_id
        WHERE a.enrollment_id = #{enrollmentId} AND a.attendance_date = #{date}
    </select>
    
    <insert id="insertAttendance" useGeneratedKeys="true" keyProperty="attendanceId">
        INSERT INTO attendance (enrollment_id, student_id, course_id, attendance_date, status, notes, created_at)
        VALUES (#{enrollmentId}, #{studentId}, #{courseId}, #{attendanceDate}, #{status}, #{notes}, CURRENT_TIMESTAMP)
    </insert>
    
    <update id="updateAttendance">
        UPDATE attendance
        SET status = #{status},
            notes = #{notes}
        WHERE attendance_id = #{attendanceId}
    </update>
    
    <delete id="deleteAttendance">
        DELETE FROM attendance
        WHERE attendance_id = #{attendanceId}
    </delete>
    
    <select id="countByEnrollmentId" resultType="int">
        SELECT COUNT(*)
        FROM attendance
        WHERE enrollment_id = #{enrollmentId}
    </select>
    
    <select id="countByEnrollmentIdAndStatus" resultType="int">
        SELECT COUNT(*)
        FROM attendance
        WHERE enrollment_id = #{enrollmentId} AND status = #{status}
    </select>
    
</mapper>
