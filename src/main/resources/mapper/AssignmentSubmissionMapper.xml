<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lmsproject.lms_backend.mapper.AssignmentSubmissionMapper">
    
    <resultMap id="AssignmentSubmissionResultMap" type="com.lmsproject.lms_backend.model.AssignmentSubmission">
        <id property="submissionId" column="submission_id"/>
        <result property="assignmentId" column="assignment_id"/>
        <result property="assignmentTitle" column="assignment_title"/>
        <result property="studentId" column="student_id"/>
        <result property="studentName" column="student_name"/>
        <result property="enrollmentId" column="enrollment_id"/>
        <result property="courseName" column="course_name"/>
        <result property="courseCode" column="course_code"/>
        <result property="content" column="content"/>
        <result property="filePath" column="file_path"/>
        <result property="fileName" column="file_name"/>
        <result property="score" column="score"/>
        <result property="feedback" column="feedback"/>
        <result property="status" column="status"/>
        <result property="submittedAt" column="submitted_at"/>
        <result property="gradedAt" column="graded_at"/>
    </resultMap>
    
    <select id="findAll" resultMap="AssignmentSubmissionResultMap">
        SELECT s.submission_id, s.assignment_id, s.student_id, s.enrollment_id,
               a.title as assignment_title,
               u.name as student_name,
               c.course_name, c.course_code,
               s.content, s.file_path, s.file_name, s.score, s.feedback, s.status,
               s.submitted_at, s.graded_at
        FROM assignment_submissions s
        LEFT JOIN assignments a ON s.assignment_id = a.assignment_id
        LEFT JOIN users u ON s.student_id = u.user_id
        LEFT JOIN enrollments e ON s.enrollment_id = e.enrollment_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        ORDER BY s.submitted_at DESC
    </select>
    
    <select id="findById" resultMap="AssignmentSubmissionResultMap">
        SELECT s.submission_id, s.assignment_id, s.student_id, s.enrollment_id,
               a.title as assignment_title,
               u.name as student_name,
               c.course_name, c.course_code,
               s.content, s.file_path, s.file_name, s.score, s.feedback, s.status,
               s.submitted_at, s.graded_at
        FROM assignment_submissions s
        LEFT JOIN assignments a ON s.assignment_id = a.assignment_id
        LEFT JOIN users u ON s.student_id = u.user_id
        LEFT JOIN enrollments e ON s.enrollment_id = e.enrollment_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE s.submission_id = #{submissionId}
    </select>
    
    <select id="findByAssignmentIdAndStudentId" resultMap="AssignmentSubmissionResultMap">
        SELECT s.submission_id, s.assignment_id, s.student_id, s.enrollment_id,
               a.title as assignment_title,
               u.name as student_name,
               c.course_name, c.course_code,
               s.content, s.file_path, s.file_name, s.score, s.feedback, s.status,
               s.submitted_at, s.graded_at
        FROM assignment_submissions s
        LEFT JOIN assignments a ON s.assignment_id = a.assignment_id
        LEFT JOIN users u ON s.student_id = u.user_id
        LEFT JOIN enrollments e ON s.enrollment_id = e.enrollment_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE s.assignment_id = #{assignmentId} AND s.student_id = #{studentId}
    </select>
    
    <select id="findByAssignmentId" resultMap="AssignmentSubmissionResultMap">
        SELECT s.submission_id, s.assignment_id, s.student_id, s.enrollment_id,
               a.title as assignment_title,
               u.name as student_name,
               c.course_name, c.course_code,
               s.content, s.file_path, s.file_name, s.score, s.feedback, s.status,
               s.submitted_at, s.graded_at
        FROM assignment_submissions s
        LEFT JOIN assignments a ON s.assignment_id = a.assignment_id
        LEFT JOIN users u ON s.student_id = u.user_id
        LEFT JOIN enrollments e ON s.enrollment_id = e.enrollment_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE s.assignment_id = #{assignmentId}
        ORDER BY s.submitted_at DESC
    </select>
    
    <select id="findByStudentId" resultMap="AssignmentSubmissionResultMap">
        SELECT s.submission_id, s.assignment_id, s.student_id, s.enrollment_id,
               a.title as assignment_title,
               u.name as student_name,
               c.course_name, c.course_code,
               s.content, s.file_path, s.file_name, s.score, s.feedback, s.status,
               s.submitted_at, s.graded_at
        FROM assignment_submissions s
        LEFT JOIN assignments a ON s.assignment_id = a.assignment_id
        LEFT JOIN users u ON s.student_id = u.user_id
        LEFT JOIN enrollments e ON s.enrollment_id = e.enrollment_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE s.student_id = #{studentId}
        ORDER BY s.submitted_at DESC
    </select>
    
    <select id="findByEnrollmentId" resultMap="AssignmentSubmissionResultMap">
        SELECT s.submission_id, s.assignment_id, s.student_id, s.enrollment_id,
               a.title as assignment_title,
               u.name as student_name,
               c.course_name, c.course_code,
               s.content, s.file_path, s.file_name, s.score, s.feedback, s.status,
               s.submitted_at, s.graded_at
        FROM assignment_submissions s
        LEFT JOIN assignments a ON s.assignment_id = a.assignment_id
        LEFT JOIN users u ON s.student_id = u.user_id
        LEFT JOIN enrollments e ON s.enrollment_id = e.enrollment_id
        LEFT JOIN courses c ON e.course_id = c.course_id
        WHERE s.enrollment_id = #{enrollmentId}
        ORDER BY s.submitted_at DESC
    </select>
    
    <insert id="insertSubmission" useGeneratedKeys="true" keyProperty="submissionId">
        INSERT INTO assignment_submissions (assignment_id, student_id, enrollment_id,
                                           content, file_path, file_name, status, submitted_at)
        VALUES (#{assignmentId}, #{studentId}, #{enrollmentId},
                #{content}, #{filePath}, #{fileName}, 'SUBMITTED', CURRENT_TIMESTAMP)
    </insert>
    
    <update id="updateSubmission">
        UPDATE assignment_submissions
        SET content = #{content},
            file_path = #{filePath},
            file_name = #{fileName},
            score = #{score},
            feedback = #{feedback},
            status = #{status},
            graded_at = CASE WHEN #{status} = 'GRADED' THEN CURRENT_TIMESTAMP ELSE graded_at END
        WHERE submission_id = #{submissionId}
    </update>
    
    <delete id="deleteSubmission">
        DELETE FROM assignment_submissions
        WHERE submission_id = #{submissionId}
    </delete>
    
    <select id="countByAssignmentId" resultType="int">
        SELECT COUNT(*)
        FROM assignment_submissions
        WHERE assignment_id = #{assignmentId}
    </select>
    
    <select id="countByAssignmentIdAndStatus" resultType="int">
        SELECT COUNT(*)
        FROM assignment_submissions
        WHERE assignment_id = #{assignmentId} AND status = #{status}
    </select>
    
</mapper>
